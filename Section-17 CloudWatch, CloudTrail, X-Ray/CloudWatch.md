# Monitoring in AWS

* AWS CloudWatch:
  * Metrics - Collect and track key metrics
  * Logs - Collect, Monitor, analyze and store log files
  * Events - Send notifications when certain events happen in your AWS
  * Alarms - react in real-time metrics / events

* AWS X-Ray
  * Troubleshooting application performand and errors
  * Distributed tracing of microservices

* AWS CloudTrail
  * **Internal monitoring** of API calls being made
  * **Audit** changes to AWS resources by your users


## CloudWatch Metrics
* Metric is variable to monitor (CPUUtilization, NetworkingIn...)
* Metrics belong to namespaces
* Dimension is an attribute of a metric (instance id, environment, etc...)
* Up to 10 dimensions per metric
* Metrics have timestamps
* Can create CloudWatch dashboards of metrics

## CloudWatch EC2 Detailed Monitoring

* EC2 instance metrics have **metrics every 5 minutes**
* With detailed monitoring (for a cost), you get data every 1 minute
* AWS Free Tier allows us to have 10 detailed monitoring metrics 

## Custom Metrics
* Possibnle to define custom metrics
* Ability to use dimensions (attributes) to segement metrics
  * Insance.id
  * Envinronment.name

* Metric resolution:
  * Standard: 1 minute
  * High resolution: up to 1 second 


* Use API call **PutMetricData**

## Alarms
* alarms are used to trigger notification for any metric
* Alarms can go to ASG Scaling, EC2 Actions, SNS notifications
* Alarm States:
  * OK
  * INSUFFICIENT_DATA
  * ALARM
* Period:
  * Length of time in seconds to evaluate the metric
  * High resolution custom metrics - can only choose 10 or 30 seconds

## Logs
* Application can send logs to CloudWatch logs using the SDK
* Can use filter expressions
* Can define log expiration policies (never expire, 30 days, etc...)
* Can collect logs from:
  * EBS - collection of logs from application
  * ECS - collection from containers
  * Lambda - collection from function logs
  * VPC Flow Logs - VPC specific logs
  * API Gateway 
  * CloudTrail based on filter
  * CloudWatch log agents - for example on EC2 Machines
* CloudWatch logs can go to:
  * Batch exporter to s3 for archival 
  * Stream to ElasticSearch cluster for further analytics
* Encryption of logs using KMS at Group Level


## CloudWatch Agent & CloudWatch Logs Agent
* By deault no logs from your EC2 machine will go to CloudWatch
* You need to run a CloudWatch Agent on EC2 to push the log files you want
* Make sure IAM permissions are correct
* Can be setup on on-premises too

## CloudWatch Logs Agent & Unified Agent
* Logs Agent
  * Old version of the agent
  * Can only send to CloudWatch logs

* Unified Agent
  * Collection additional system-level metrics such as RAM, processes, etc...
  *  Collect logs to send to CloudWatch Logs
  * Centralized config using SSM Parameter Store


## Metric Filter
* CloudWatch Logs can use filter expressions:
  * For example: find a specific IP inside of a log
  * Or cound occurences of "ERROR" in you logs
  * Metric filters can be used to trigger alarms

## CloudWatch Events
* Schedule using Cron Jobs
* Event Pattern: Event rules to react to a sercice doing something 
  E.g. CodePipeline state changes

* Triggers to Lambda functions, SQS, SNS, Kinesis Mesages
* Creates small JSON document to give information about the change

## AWS EventBridge
* is the next evolution of CloudWatch Events
* Default event bus: generated by AWS services
* Partner event bus: receive events from Saas or application (Zendesk, Datadog, Segment, Auth0...)
* Custom event bus: for you own applications
* Rules: how to process the events (similar to CloudWatch Events)
* Schema Registry - allows you to generate code for you application, that will know in advance how data is structured in the event bus
* Schema can be versioned